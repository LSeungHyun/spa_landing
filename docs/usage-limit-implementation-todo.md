# 📋 사용자 횟수 제한 시스템 구현 TODO 리스트

## 🤖 자동 작업 진행 가이드
**커서 AI 자동 진행 활성화**: ✅ 활성화됨  
**진행 방식**: 순차적 Phase 진행 (Phase 1 → Phase 2 → ... → Phase 8)  
**현재 작업 대상**: Phase 1의 첫 번째 미완료 항목부터 시작  

### 자동 진행 규칙
1. **"작업 진행해" 명령 시**: 현재 Phase의 다음 미완료 작업 항목 자동 실행
2. **파일 생성/수정**: 자동으로 필요한 코드 파일 생성 및 수정
3. **상태 업데이트**: 작업 완료 후 이 문서의 상태 자동 업데이트
4. **중간 점검**: Phase 내 모든 작업 완료 시 중간 점검 체크리스트 확인
5. **다음 Phase 진행**: 중간 점검 통과 시 자동으로 다음 Phase 시작

### 현재 작업 위치
- **활성 Phase**: Phase 1 (서버 사이드 인프라 구축)
- **다음 작업**: IP 기반 사용 제한 데이터베이스 테이블 설계
- **우선순위**: 높음 (핵심 인프라)

### 자동 생성 파일 경로 매핑
```
Phase 1:
- 데이터베이스 스키마: src/lib/database/usage-limit-schema.sql
- IP 유틸리티: src/lib/utils/ip-utils.ts
- 서비스 함수: src/lib/services/usage-limit-service.ts
- 타입 정의: src/types/usage-limit.ts

Phase 2:
- API 라우트: src/app/api/improve-prompt/route.ts (수정)
- 에러 타입: src/types/api-errors.ts
- IP 추출 미들웨어: src/lib/middleware/ip-extractor.ts

Phase 3:
- 클라이언트 훅: src/hooks/use-usage-limit-sync.ts
- 동기화 유틸: src/lib/utils/sync-utils.ts
- UI 컴포넌트: src/components/shared/usage-indicator.tsx
```

---

## 🎯 프로젝트 개요
- **목적**: localStorage 기반 제한의 취약점을 보완하기 위한 IP 기반 서버 사이드 검증 시스템 구축
- **목표**: 3회 사용 제한을 클라이언트와 서버 양쪽에서 검증하여 우회 방지
- **최종 목표**: 안전하고 견고한 사용 제한으로 API 비용 절약 및 사전 등록 유도

---

## 📊 전체 진행 상황
- **전체 Phase**: 8개
- **완료된 Phase**: 0개
- **진행 중인 Phase**: Phase 1
- **전체 진행률**: 0%

---

## 🚀 Phase 1: 서버 사이드 인프라 구축
**상태**: ⏳ 대기 중  
**예상 소요 시간**: 2-3일  
**담당자**: 개발팀  
**완료 기한**: TBD

### 작업 항목
- [ ] **IP 기반 사용 제한 데이터베이스 테이블 설계**
  - 상태: ⏳ 대기 중
  - 파일 경로: `src/lib/database/usage-limit-schema.sql`
  - 세부사항: IP 주소, 사용 횟수, 마지막 사용 시간, 생성일 컬럼 포함
  - 구현 요구사항:
    - Supabase PostgreSQL 호환 스키마
    - IP 주소 인덱스 최적화
    - 자동 TTL 정책 (24시간 후 자동 삭제)
    - 동시성 처리를 위한 적절한 제약조건
  - 검증 기준: 테이블 생성 및 인덱스 설정 완료
  - 자동 생성 가능: ✅

- [ ] **Redis/Upstash 캐시 설정 (빠른 조회를 위한)**
  - 상태: ⏳ 대기 중
  - 파일 경로: `src/lib/cache/redis-config.ts`
  - 세부사항: 캐시 연결 설정 및 TTL 정책 수립
  - 구현 요구사항:
    - Upstash Redis 연결 설정
    - 환경변수 기반 설정 관리
    - 캐시 키 네이밍 컨벤션 정의
    - TTL 정책: 1시간 (3600초)
  - 검증 기준: 캐시 연결 테스트 성공
  - 자동 생성 가능: ✅

- [ ] **IP 주소 추출 및 정규화 유틸리티 함수 작성**
  - 상태: ⏳ 대기 중
  - 파일 경로: `src/lib/utils/ip-utils.ts`
  - 세부사항: IPv4/IPv6 처리, 프록시 헤더 고려
  - 구현 요구사항:
    - Next.js Request 객체에서 실제 IP 추출
    - X-Forwarded-For, X-Real-IP 헤더 처리
    - IPv6을 IPv4로 매핑 처리
    - IP 정규화 및 검증 함수
    - 로컬/개발 환경 대응
  - 검증 기준: 다양한 IP 형식에 대한 단위 테스트 통과
  - 자동 생성 가능: ✅

- [ ] **사용 횟수 증가/조회/롤백 서비스 함수 구현**
  - 상태: ⏳ 대기 중
  - 파일 경로: `src/lib/services/usage-limit-service.ts`
  - 세부사항: 원자적 연산 보장, 동시성 처리
  - 구현 요구사항:
    - Supabase 클라이언트 기반 CRUD 작업
    - Redis 캐시 통합 (캐시 우선 조회)
    - 트랜잭션 처리 및 롤백 메커니즘
    - 에러 처리 및 재시도 로직
    - TypeScript 엄격 타입 정의
  - 검증 기준: 동시 요청 테스트 통과
  - 자동 생성 가능: ✅

- [ ] **타입 정의 및 인터페이스 작성**
  - 상태: ⏳ 대기 중
  - 파일 경로: `src/types/usage-limit.ts`
  - 세부사항: 사용 제한 관련 모든 타입 정의
  - 구현 요구사항:
    - 데이터베이스 엔티티 타입
    - API 요청/응답 타입
    - 서비스 함수 매개변수 타입
    - 에러 타입 정의
    - 유틸리티 함수 타입
  - 검증 기준: TypeScript 컴파일 오류 없음
  - 자동 생성 가능: ✅

### 🚀 자동 진행 명령어 가이드
**기본 명령어:**
- `"작업 진행해"` - 다음 미완료 작업 자동 실행
- `"Phase 1 진행해"` - Phase 1 작업들 순차 실행
- `"데이터베이스 스키마 생성해"` - 특정 작업 직접 실행

**상태 확인 명령어:**
- `"진행 상황 확인해"` - 현재 진행률 및 상태 확인
- `"다음 작업이 뭐야?"` - 다음 수행할 작업 확인
- `"완료된 작업 보여줘"` - 완료된 작업 목록 표시

### 📋 작업 의존성 관계
```
타입 정의 (usage-limit.ts)
    ↓
데이터베이스 스키마 (usage-limit-schema.sql)
    ↓
IP 유틸리티 (ip-utils.ts) + Redis 설정 (redis-config.ts)
    ↓
사용 제한 서비스 (usage-limit-service.ts)
```

### 🧪 자동 테스트 생성
- **단위 테스트**: `src/__tests__/utils/ip-utils.test.ts`
- **서비스 테스트**: `src/__tests__/services/usage-limit-service.test.ts`
- **통합 테스트**: `src/__tests__/integration/usage-limit.test.ts`

### 🔍 Phase 1 중간 점검 체크리스트
- [ ] 데이터베이스 연결 및 테이블 생성 확인
- [ ] 캐시 시스템 정상 작동 확인
- [ ] IP 추출 함수 다양한 환경에서 테스트
- [ ] 서비스 함수 단위 테스트 100% 통과
- [ ] 성능 벤치마크 기준치 달성
- [ ] 타입 정의 완전성 검증
- [ ] 의존성 관계 정확성 확인

---

## 🔧 Phase 2: API 라우트 개선
**상태**: ⏳ 대기 중  
**예상 소요 시간**: 2-3일  
**담당자**: 개발팀  
**완료 기한**: TBD

### 작업 항목
- [ ] **`/api/improve-prompt` 라우트에 IP 기반 제한 로직 추가**
  - 상태: ⏳ 대기 중
  - 세부사항: 기존 라우트에 IP 검증 로직 통합
  - 검증 기준: API 응답 시간 < 500ms 유지

- [ ] **클라이언트 IP 주소 추출 로직 구현**
  - 상태: ⏳ 대기 중
  - 세부사항: Next.js Request 객체에서 실제 IP 추출
  - 검증 기준: 다양한 배포 환경에서 정확한 IP 추출

- [ ] **사용 횟수 초과 시 HTTP 429 응답 처리**
  - 상태: ⏳ 대기 중
  - 세부사항: 표준화된 에러 응답 형식 정의
  - 검증 기준: 클라이언트에서 적절한 에러 처리 확인

- [ ] **Gemini API 실패 시 사용 횟수 롤백 로직 추가**
  - 상태: ⏳ 대기 중
  - 세부사항: 트랜잭션 처리 및 롤백 메커니즘
  - 검증 기준: API 실패 시나리오에서 정확한 롤백

- [ ] **응답에 남은 사용 횟수 정보 포함**
  - 상태: ⏳ 대기 중
  - 세부사항: 응답 스키마 정의 및 구현
  - 검증 기준: 클라이언트에서 정확한 정보 표시

### 🔍 Phase 2 중간 점검 체크리스트
- [ ] API 라우트 정상 작동 확인
- [ ] IP 추출 로직 프로덕션 환경 테스트
- [ ] 에러 응답 형식 표준화 확인
- [ ] 롤백 로직 시나리오 테스트
- [ ] 응답 데이터 구조 검증

---

## 💻 Phase 3: 클라이언트 사이드 개선
**상태**: ⏳ 대기 중  
**예상 소요 시간**: 2일  
**담당자**: 개발팀  
**완료 기한**: TBD

### 작업 항목
- [ ] **서버 응답과 localStorage 동기화 로직 구현**
  - 상태: ⏳ 대기 중
  - 세부사항: 서버 데이터를 기준으로 localStorage 업데이트
  - 검증 기준: 동기화 로직 정확성 테스트

- [ ] **서버 제한 응답 처리 (429 에러 핸들링)**
  - 상태: ⏳ 대기 중
  - 세부사항: 429 응답 시 적절한 UI 표시
  - 검증 기준: 사용자 친화적 에러 메시지 표시

- [ ] **localStorage와 서버 정보 불일치 시 처리 로직**
  - 상태: ⏳ 대기 중
  - 세부사항: 불일치 감지 및 서버 데이터 우선 적용
  - 검증 기준: 불일치 시나리오 테스트 통과

- [ ] **사용 현황 UI 컴포넌트 서버 데이터 기반으로 업데이트**
  - 상태: ⏳ 대기 중
  - 세부사항: 실시간 사용 현황 표시 개선
  - 검증 기준: UI 정확성 및 반응성 확인

### 🔍 Phase 3 중간 점검 체크리스트
- [ ] 동기화 로직 다양한 시나리오 테스트
- [ ] 에러 핸들링 사용자 경험 검증
- [ ] 불일치 처리 로직 안정성 확인
- [ ] UI 컴포넌트 반응성 테스트
- [ ] 크로스 브라우저 호환성 확인

---

## 🛡️ Phase 4: 에러 처리 및 사용자 경험
**상태**: ⏳ 대기 중  
**예상 소요 시간**: 2일  
**담당자**: 개발팀  
**완료 기한**: TBD

### 작업 항목
- [ ] **네트워크 오류 시 fallback 로직 구현**
  - 상태: ⏳ 대기 중
  - 세부사항: 오프라인 상태 처리 및 재시도 메커니즘
  - 검증 기준: 네트워크 오류 시나리오 테스트

- [ ] **서버 제한 도달 시 전용 모달 컴포넌트 작성**
  - 상태: ⏳ 대기 중
  - 세부사항: 사전 등록 유도를 위한 전용 UI
  - 검증 기준: 모달 UX 및 전환율 측정

- [ ] **localStorage 조작 감지 및 서버 동기화 로직**
  - 상태: ⏳ 대기 중
  - 세부사항: 조작 감지 시 서버 검증 강화
  - 검증 기준: 조작 시나리오 테스트 통과

- [ ] **사용자 친화적 에러 메시지 및 안내 문구 작성**
  - 상태: ⏳ 대기 중
  - 세부사항: 다국어 지원 및 명확한 안내
  - 검증 기준: 사용성 테스트 통과

### 🔍 Phase 4 중간 점검 체크리스트
- [ ] 오류 처리 로직 안정성 확인
- [ ] 모달 컴포넌트 사용성 테스트
- [ ] 조작 감지 정확성 검증
- [ ] 에러 메시지 명확성 평가
- [ ] 전체적인 사용자 경험 개선도 측정

---

## 🔒 Phase 5: 보안 및 남용 방지
**상태**: ⏳ 대기 중  
**예상 소요 시간**: 3일  
**담당자**: 개발팀  
**완료 기한**: TBD

### 작업 항목
- [ ] **프록시/VPN 사용 감지 로직 (선택사항)**
  - 상태: ⏳ 대기 중
  - 세부사항: 의심스러운 IP 패턴 감지
  - 검증 기준: 정확도 vs 오탐율 균형

- [ ] **단시간 대량 요청 방지 (Rate Limiting)**
  - 상태: ⏳ 대기 중
  - 세부사항: 시간 기반 요청 제한 로직
  - 검증 기준: 정상 사용자 영향 최소화

- [ ] **IP 화이트리스트/블랙리스트 관리 시스템**
  - 상태: ⏳ 대기 중
  - 세부사항: 관리자 인터페이스 및 자동 관리
  - 검증 기준: 관리 효율성 및 정확성

- [ ] **의심스러운 사용 패턴 모니터링 및 알림**
  - 상태: ⏳ 대기 중
  - 세부사항: 실시간 모니터링 및 알림 시스템
  - 검증 기준: 알림 정확성 및 대응 시간

### 🔍 Phase 5 중간 점검 체크리스트
- [ ] 보안 로직 효과성 검증
- [ ] Rate Limiting 정상 작동 확인
- [ ] 관리 시스템 사용성 테스트
- [ ] 모니터링 시스템 정확성 확인
- [ ] 보안 취약점 점검 완료

---

## 📊 Phase 6: 모니터링 및 분석
**상태**: ⏳ 대기 중  
**예상 소요 시간**: 2일  
**담당자**: 개발팀  
**완료 기한**: TBD

### 작업 항목
- [ ] **IP별 사용 패턴 분석 대시보드**
  - 상태: ⏳ 대기 중
  - 세부사항: 실시간 사용 통계 및 시각화
  - 검증 기준: 대시보드 정확성 및 성능

- [ ] **localStorage vs 서버 제한 도달 비율 추적**
  - 상태: ⏳ 대기 중
  - 세부사항: 우회 시도 패턴 분석
  - 검증 기준: 데이터 정확성 및 인사이트 도출

- [ ] **우회 시도 감지 및 로깅**
  - 상태: ⏳ 대기 중
  - 세부사항: 상세한 로그 수집 및 분석
  - 검증 기준: 로그 완전성 및 분석 가능성

- [ ] **사전 등록 전환율 분석 (제한 도달 후)**
  - 상태: ⏳ 대기 중
  - 세부사항: 전환 퍼널 분석 및 최적화
  - 검증 기준: 전환율 개선 방안 도출

### 🔍 Phase 6 중간 점검 체크리스트
- [ ] 대시보드 데이터 정확성 검증
- [ ] 분석 로직 신뢰성 확인
- [ ] 로깅 시스템 완전성 테스트
- [ ] 전환율 분석 유효성 검증
- [ ] 비즈니스 인사이트 도출 가능성 확인

---

## ⚡ Phase 7: 성능 최적화
**상태**: ⏳ 대기 중  
**예상 소요 시간**: 2일  
**담당자**: 개발팀  
**완료 기한**: TBD

### 작업 항목
- [ ] **IP 기반 조회 성능 최적화 (인덱싱)**
  - 상태: ⏳ 대기 중
  - 세부사항: 데이터베이스 인덱스 최적화
  - 검증 기준: 조회 성능 목표치 달성

- [ ] **캐시 전략 수립 및 TTL 설정**
  - 상태: ⏳ 대기 중
  - 세부사항: 효율적인 캐시 정책 수립
  - 검증 기준: 캐시 적중률 및 성능 개선

- [ ] **데이터베이스 쿼리 최적화**
  - 상태: ⏳ 대기 중
  - 세부사항: 쿼리 실행 계획 분석 및 최적화
  - 검증 기준: 쿼리 실행 시간 단축

- [ ] **서버 응답 시간 모니터링**
  - 상태: ⏳ 대기 중
  - 세부사항: 실시간 성능 모니터링 시스템
  - 검증 기준: SLA 기준 달성

### 🔍 Phase 7 중간 점검 체크리스트
- [ ] 성능 개선 목표치 달성 확인
- [ ] 캐시 효율성 검증
- [ ] 쿼리 성능 최적화 완료
- [ ] 모니터링 시스템 정상 작동
- [ ] 전체 시스템 성능 벤치마크 통과

---

## 🧪 Phase 8: 테스트 및 검증
**상태**: ⏳ 대기 중  
**예상 소요 시간**: 3일  
**담당자**: 개발팀  
**완료 기한**: TBD

### 작업 항목
- [ ] **IP 기반 제한 로직 단위 테스트**
  - 상태: ⏳ 대기 중
  - 세부사항: 모든 제한 로직에 대한 포괄적 테스트
  - 검증 기준: 테스트 커버리지 95% 이상

- [ ] **localStorage 조작 시나리오 테스트**
  - 상태: ⏳ 대기 중
  - 세부사항: 다양한 조작 패턴에 대한 대응 테스트
  - 검증 기준: 모든 우회 시도 차단 확인

- [ ] **동시 요청 처리 테스트**
  - 상태: ⏳ 대기 중
  - 세부사항: 고부하 상황에서의 정확성 테스트
  - 검증 기준: 동시성 문제 없음 확인

- [ ] **다양한 네트워크 환경에서의 통합 테스트**
  - 상태: ⏳ 대기 중
  - 세부사항: 실제 사용 환경 시뮬레이션
  - 검증 기준: 모든 환경에서 정상 작동

### 🔍 Phase 8 중간 점검 체크리스트
- [ ] 단위 테스트 완전성 확인
- [ ] 시나리오 테스트 통과율 100%
- [ ] 동시성 테스트 안정성 확인
- [ ] 통합 테스트 성공률 검증
- [ ] 프로덕션 배포 준비 완료

---

## 📈 전체 프로젝트 진행 상황 추적

### 완료된 Phase
*아직 완료된 Phase가 없습니다.*

### 현재 진행 중인 작업
- **Phase**: 1 (서버 사이드 인프라 구축)
- **진행률**: 0%
- **예상 완료일**: TBD

### 다음 마일스톤
- **Phase 1 완료**: TBD
- **Phase 2 시작**: TBD
- **전체 프로젝트 완료**: TBD

---

## 🔄 업데이트 로그

### 2024-12-19
- 초기 TODO 리스트 생성
- 8개 Phase 구조 설정
- 상세 작업 항목 정의 완료

---

## 📝 참고사항

### 중간 점검 가이드라인
1. **각 Phase 완료 시 중간 점검 실시**
2. **체크리스트 항목 100% 완료 후 다음 Phase 진행**
3. **문제 발견 시 해당 Phase 재작업**
4. **진행 상황을 이 문서에 실시간 업데이트**

### 업데이트 규칙
- **작업 상태 변경**: ⏳ 대기 중 → 🔄 진행 중 → ✅ 완료
- **진행률 업데이트**: 각 작업 항목 완료 시마다 업데이트
- **문제 발생 시**: ❌ 문제 발생 상태로 표시 및 해결 방안 기록

### 상태 아이콘 범례
- ⏳ 대기 중
- 🔄 진행 중  
- ✅ 완료
- ❌ 문제 발생
- ⚠️ 주의 필요
- 🔍 검토 중 